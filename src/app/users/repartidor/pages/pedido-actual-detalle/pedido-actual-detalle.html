<app-header></app-header>

<!-- Modal de Confirmaci√≥n -->
@if (mostrarModalConfirmacion()) {
  <div class="modal-overlay" (click)="cerrarModalConfirmacion()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalTitulo() }}</h3>
        <button class="close-btn" (click)="cerrarModalConfirmacion()">√ó</button>
      </div>
      <div class="modal-body">
        <p>{{ modalMensaje() }}</p>
      </div>
      <div class="modal-actions">
        <button class="btn-confirmar" (click)="confirmarEntrega()" [disabled]="marcandoEntregado()">
          {{ marcandoEntregado() ? 'Procesando...' : 'S√≠, Marcar como Entregado' }}
        </button>
        <button
          class="btn-cancelar"
          (click)="cerrarModalConfirmacion()"
          [disabled]="marcandoEntregado()"
        >
          Cancelar
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal de √âxito/Error -->
@if (mostrarModalExito()) {
  <div class="modal-overlay" (click)="cerrarModalExito()">
    <div class="modal-content" [class.success]="modalTitulo() === '¬°Buen Trabajo!'">
      <div class="modal-header">
        <h3>{{ modalTitulo() }}</h3>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          {{ modalTitulo() === '¬°Buen Trabajo!' ? '‚úì' : '‚ö†' }}
        </div>
        <p>{{ modalMensaje() }}</p>
      </div>
      <div class="modal-actions">
        <button class="btn-ok" (click)="cerrarModalExito()">
          {{ modalTitulo() === '¬°Buen Trabajo!' ? 'Volver al Panel' : 'Aceptar' }}
        </button>
      </div>
    </div>
  </div>
}

<div class="content">
  <div class="pedido-detalle-container">
    <div class="breadcrumb">
      <button class="btn-volver" (click)="volverAlPanel()">‚Üê Volver al Panel</button>
    </div>

    @if (loading()) {
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Cargando detalles del pedido...</p>
      </div>
    } @else {
      @if (pedido(); as p) {
        <div class="pedido-detail">
          <!-- Header Principal -->
          <div class="pedido-header-principal">
            <div class="pedido-titulo-seccion">
              <h2>Pedido #{{ p.id }}</h2>
              <span class="estado-badge" [class]="'estado-' + p.estado.toLowerCase()">{{ p.estado }}</span>
            </div>
            <div class="pedido-monto-seccion">
              <p class="label">Total a Entregar</p>
              <p class="monto">${{ p.total }}</p>
            </div>
          </div>

          <!-- Secci√≥n: Restaurante -->
          <div class="info-section restaurante-section">
            <h3 class="section-titulo">üìç Datos del Restaurante</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Nombre:</span>
                <span class="valor">{{ p.restauranteNombre }}</span>
              </div>
              <div class="info-item">
                <span class="label">Direcci√≥n de Retiro:</span>
                <span class="valor">{{ p.restauranteDireccion }}</span>
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Cliente -->
          <div class="info-section cliente-section">
            <h3 class="section-titulo">üë§ Datos del Cliente</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Nombre:</span>
                <span class="valor">{{ p.clienteNombre }}</span>
              </div>
              <div class="info-item">
                <span class="label">Direcci√≥n de Entrega:</span>
                <span class="valor">{{ p.direccionEntrega }}</span>
              </div>
            </div>
          </div>

          <!-- Secci√≥n: Detalles -->
          <div class="info-section detalles-section">
            <h3 class="section-titulo">üìã Detalles del Pedido</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Fecha del Pedido:</span>
                <span class="valor">{{ p.fecha }}</span>
              </div>
              <div class="info-item">
                <span class="label">C√≥digo Postal Entrega:</span>
                <span class="valor">{{ p.codigoPostal || 'No especificado' }}</span>
              </div>
            </div>
          </div>

          <!-- Timeline de Entrega -->
          <div class="timeline-section">
            <h3 class="section-titulo">üìä Estado de Entrega</h3>
            <div class="timeline">
              <div
                class="timeline-item"
                [class.completado]="
                  p.estado === 'ACEPTADO' || p.estado === 'EN_ENTREGA' || p.estado === 'ENTREGADO'
                "
              >
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <p class="timeline-label">Pedido Aceptado</p>
                  <p class="timeline-desc">Ya aceptaste este pedido</p>
                </div>
              </div>
              <div
                class="timeline-item"
                [class.completado]="p.estado === 'EN_ENTREGA' || p.estado === 'ENTREGADO'"
              >
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <p class="timeline-label">En Entrega</p>
                  <p class="timeline-desc">Est√°s en camino al cliente</p>
                  @if (p.estado === 'ACEPTADO') {
                    <button
                      class="btn-estado"
                      (click)="cambiarEstado('EN_ENTREGA')"
                      [disabled]="marcandoEntregado()"
                    >
                      Empezar Entrega
                    </button>
                  }
                </div>
              </div>
              <div class="timeline-item" [class.completado]="p.estado === 'ENTREGADO'">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <p class="timeline-label">Entregado</p>
                  <p class="timeline-desc">Marca como completado</p>
                  @if (p.estado === 'EN_ENTREGA') {
                    <button
                      class="btn-estado btn-completar"
                      (click)="cambiarEstado('ENTREGADO')"
                      [disabled]="marcandoEntregado()"
                    >
                      {{ marcandoEntregado() ? '‚è≥ Completando...' : '‚úì Completar Entrega' }}
                    </button>
                  }
                </div>
              </div>
            </div>
          </div>

          <!-- Botones de Acci√≥n -->
          <div class="acciones-section">
            <button
              class="btn-entregar"
              (click)="marcarComoEntregado()"
              [disabled]="marcandoEntregado()"
            >
              {{ marcandoEntregado() ? '‚è≥ Procesando...' : '‚úì Marcar como Entregado' }}
            </button>
            <button class="btn-volver" (click)="volverAlPanel()">‚Üê Volver al Panel</button>
          </div>
        </div>
      } @else {
        <div class="sin-pedido">
          <div class="sin-pedido-icon">üì≠</div>
          <h3>No tienes un pedido actual</h3>
          <p>Explora los pedidos disponibles para aceptar uno y comenzar a entregar.</p>
          <button
            class="btn-explorar"
            (click)="router.navigate(['/repartidor/pedidos-disponibles'])"
          >
            Explorar Pedidos Disponibles
          </button>
        </div>
      }
    }
  </div>
</div>

<app-footer-repartidor></app-footer-repartidor>
