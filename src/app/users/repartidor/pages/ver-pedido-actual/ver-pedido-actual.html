<app-header></app-header>

<!-- Modal de Confirmaci√≥n -->
@if (mostrarModalConfirmacion()) {
  <div class="modal-overlay" (click)="cerrarModalConfirmacion()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalTitulo() }}</h3>
        <button class="close-btn" (click)="cerrarModalConfirmacion()">√ó</button>
      </div>
      <div class="modal-body">
        <p>{{ modalMensaje() }}</p>
      </div>
      <div class="modal-actions">
        <button class="btn-confirmar" (click)="confirmarEntrega()" [disabled]="marcandoEntregado()">
          {{ marcandoEntregado() ? 'Procesando...' : 'S√ç' }}
        </button>
        <button
          class="btn-cancelar"
          (click)="cerrarModalConfirmacion()"
          [disabled]="marcandoEntregado()"
        >
          Cancelar
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal de √âxito/Error -->
@if (mostrarModalExito()) {
  <div class="modal-overlay" (click)="cerrarModalExito()">
    <div class="modal-content" [class.success]="modalTitulo() === '¬°Buen Trabajo!'">
      <div class="modal-header">
        <h3>{{ modalTitulo() }}</h3>
      </div>
      <div class="modal-body">
        <div class="modal-icon">
          {{ modalTitulo() === '¬°Buen Trabajo!' ? '‚úì' : '‚ö†' }}
        </div>
        <p>{{ modalMensaje() }}</p>
      </div>
      <div class="modal-actions">
        <button class="btn-ok" (click)="cerrarModalExito()">
          {{ modalTitulo() === '¬°Buen Trabajo!' ? 'Volver al Panel' : 'Aceptar' }}
        </button>
      </div>
    </div>
  </div>
}

<div class="content">
  <div class="pedido-actual-container">
    <h2>Mi Pedido Actual</h2>

    @if (loading()) {
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Cargando tu pedido actual...</p>
      </div>
    } @else {
      @if (pedido(); as p) {
        <div class="pedido-detail">
          <!-- Header -->
          <div class="pedido-header">
            <div class="pedido-titulo">
              <h3>Pedido #{{ p.id }}</h3>
            </div>
            <div class="pedido-monto">
              <p class="label">Total</p>
              <p class="monto">${{ p.total }}</p>
            </div>
          </div>

          <!-- Informaci√≥n del Restaurante -->
          <div class="info-section">
            <h4>üìç Datos del Restaurante</h4>
            <div class="info-content">
              <div class="info-item">
                <span class="label">Restaurante:</span>
                <span class="valor">{{ p.restauranteNombre }}</span>
              </div>
              <div class="info-item">
                <span class="label">Direcci√≥n:</span>
                <span class="valor">{{ p.restauranteDireccion }}</span>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n del Cliente -->
          <div class="info-section">
            <h4>üë§ Datos del Cliente</h4>
            <div class="info-content">
              <div class="info-item">
                <span class="label">Cliente:</span>
                <span class="valor">{{ p.clienteNombre }}</span>
              </div>
              <div class="info-item">
                <span class="label">Entregar en:</span>
                <span class="valor">{{ p.direccionEntrega }}</span>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n General -->
          <div class="info-section">
            <h4>üìã Detalles del Pedido</h4>
            <div class="info-content">
              <div class="info-item">
                <span class="label">Fecha del Pedido:</span>
                <span class="valor">{{ p.fecha }}</span>
              </div>
              <div class="info-item">
                <span class="label">Estado:</span>
                <span class="valor estado-texto">{{ p.estado }}</span>
              </div>
            </div>
          </div>

          <!-- Timeline de entrega con botones de estado -->
          <div class="timeline-section">
            <h4>üìä Estado de Entrega</h4>
            <div class="timeline">
              <div
                class="timeline-item"
                [class.completado]="p.estado === 'ENVIADO' || p.estado === 'ENTREGADO'"
              >
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <p class="timeline-label">Enviado</p>
                  <p class="timeline-desc">El pedido est√° en camino al cliente</p>
                </div>
              </div>
              <div class="timeline-item" [class.completado]="p.estado === 'ENTREGADO'">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <p class="timeline-label">Entregado</p>
                  <p class="timeline-desc">Pedido completado exitosamente</p>
                  @if (p.estado === 'ENVIADO') {
                    <button
                      class="btn-estado btn-completar"
                      (click)="marcarComoEntregado()"
                      [disabled]="marcandoEntregado()"
                    >
                      {{ marcandoEntregado() ? '‚è≥ Procesando...' : '‚úì Marcar como Entregado' }}
                    </button>
                  }
                </div>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="acciones-section">
            @if (p.estado === 'ENVIADO') {
              <button
                class="btn-entregar"
                (click)="marcarComoEntregado()"
                [disabled]="marcandoEntregado()"
              >
                {{ marcandoEntregado() ? '‚è≥ Procesando...' : '‚úì Marcar como Entregado' }}
              </button>
            }
            <button class="btn-volver" (click)="volverAlPanel()">‚Üê Volver al Panel</button>
          </div>
        </div>
      } @else {
        <div class="sin-pedido">
          <div class="sin-pedido-icon">üì≠</div>
          <h3>No tienes un pedido actual</h3>
          <p>Explora los pedidos disponibles para aceptar uno y comenzar a entregar.</p>
          <button
            class="btn-explorar"
            (click)="router.navigate(['/repartidor/pedidos-disponibles'])"
          >
            Explorar Pedidos Disponibles
          </button>
        </div>
      }
    }
  </div>
</div>
<app-footer-repartidor></app-footer-repartidor>
