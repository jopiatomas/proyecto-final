<app-header></app-header>

<main class="ver-restaurante">
  <div class="main-content">
    @if (loading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Cargando informaci√≥n del restaurante...</p>
    </div>
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Cargando informaci√≥n del restaurante...</p>
    </div>
    } @else if (restaurante) {
    <!-- Header del Restaurante -->
    <section class="restaurant-header">
      <div class="header-content">
        <h2>{{ restaurante.nombre }}</h2>
        <div class="status-badges">
          @if (isRestauranteAbierto()) {
            <span class="badge badge-abierto">üü¢ ABIERTO</span>
          } @else {
            <span class="badge badge-cerrado">üî¥ CERRADO</span>
          }
        </div>
      </div>

      @if (restaurante.horaApertura && restaurante.horaCierre) {
        <div class="horario-info">
          <span class="horario-label">‚è∞ Horario:</span>
          <span class="horario-text">
            {{ formatearHorario(restaurante.horaApertura) }} - {{ formatearHorario(restaurante.horaCierre) }}
          </span>
        </div>
      }

      @if (resenias.length > 0) {
      <div class="rating-info">
        <span class="stars">
          @for (estrella of estrellas; track estrella) {
          <span [class.filled]="estrella <= calcularPromedioPuntuacion()">‚òÖ</span>
          }
        </span>
        <span class="rating-text">
          {{ formatearPuntuacion(calcularPromedioPuntuacion()) }}
          ({{ resenias.length }} {{ resenias.length === 1 ? 'rese√±a' : 'rese√±as' }})
        </span>
      </div>
      }

      @if (!isRestauranteAbierto()) {
        <div class="alert-cerrado">
          <p>‚ö†Ô∏è El restaurante est√° cerrado en este momento. No es posible realizar pedidos.</p>
        </div>
      }
    </section>


    <!-- Men√∫ del Restaurante -->
    <section class="menu-section">
      <div class="container">
        <div class="section-header">
          <h2>Men√∫</h2>
          <p>Descubre nuestra deliciosa selecci√≥n de platos</p>
        </div>

        @if (loadingMenu) {
        <div class="loading-menu">
          <div class="loading-spinner"></div>
          <p>Cargando men√∫...</p>
        </div>
        <div class="loading-menu">
          <div class="loading-spinner"></div>
          <p>Cargando men√∫...</p>
        </div>
        } @else if (menu.length > 0) {
        <div class="menu-grid">
          @for (producto of menu; track producto.id) {
          <div class="menu-item" [class.sin-stock]="!tieneStock(producto)">
            <div class="item-content">
              <h3>{{ producto.nombre }}</h3>
              <p class="price">{{ formatearPrecio(producto.precio) }}</p>
              @if (!tieneStock(producto)) {
              <p class="sin-stock-text">Sin stock</p>
              } @else if (producto.stock && producto.stock <= 5) {
              <p class="stock-bajo">Quedan {{ producto.stock }} unidades</p>
              }
            </div>
            <button
              class="add-btn"
              type="button"
              (click)="agregarAlCarrito(producto)"
              [disabled]="!tieneStock(producto) || !isRestauranteAbierto()"
              [class.disabled]="!tieneStock(producto) || !isRestauranteAbierto()"
              [attr.title]="!isRestauranteAbierto() ? 'Restaurante cerrado' : (!tieneStock(producto) ? 'Sin stock' : 'Agregar al carrito')"
            >
              <span>+</span>
            </button>
          </div>
          }
        </div>
        } @else {
        <div class="empty-menu">
          <p>Este restaurante a√∫n no tiene productos en su men√∫.</p>
        </div>
        <div class="empty-menu">
          <p>Este restaurante a√∫n no tiene productos en su men√∫.</p>
        </div>
        }
      </div>
    </section>

    <!-- Secci√≥n de Rese√±as -->
    <section class="reviews-section">
      <div class="container">
        <div class="section-header">
          <h2>Rese√±as</h2>
          <button class="review-btn" type="button" (click)="toggleFormularioResenia()">
            {{ mostrarFormularioResenia ? 'Cancelar' : 'Escribir Rese√±a' }}
          </button>
        </div>

        <!-- Formulario para Nueva Rese√±a -->
        @if (mostrarFormularioResenia) {
        <form [formGroup]="reseniaForm" (ngSubmit)="submitResenia()" class="review-form">
          <h3>Deja tu rese√±a</h3>

          <!-- Rating -->
          <div class="rating-input">
            <label>Calificaci√≥n:</label>
            <div class="stars-input">
              @for (estrella of estrellas; track estrella) {
              <button
                type="button"
                class="star-btn"
                [class.selected]="estrella <= reseniaForm.value.puntuacion"
                (click)="establecerPuntuacion(estrella)"
              >
                ‚òÖ
              </button>
              }
            </div>
          </div>

          <!-- Comentario -->
          <div class="form-group">
            <label for="resenia">Tu comentario:</label>
            <textarea
              id="resenia"
              formControlName="resenia"
              placeholder="Cu√©ntanos sobre tu experiencia..."
              rows="4"
            >
            </textarea>
            @if (reseniaForm.get('resenia')?.touched && reseniaForm.get('resenia')?.errors) {
            <div class="error-message">
              @if (reseniaForm.get('resenia')?.errors?.['required']) { El comentario es obligatorio
              } @if (reseniaForm.get('resenia')?.errors?.['minlength']) { El comentario debe tener
              al menos 10 caracteres } @if (reseniaForm.get('resenia')?.errors?.['maxlength']) { El
              comentario no puede exceder los 500 caracteres }
            </div>
            }
          </div>

          <!-- Botones -->

          <button
            type="submit"
            class="submit-btn"
            [disabled]="reseniaForm.invalid || submittingResenia"
          >
            @if (submittingResenia) { Enviando... } @else { Enviar Rese√±a }
          </button>
        </form>
        }

        <!-- Lista de Rese√±as -->
        @if (resenias.length > 0) {
        <div class="reviews-list">
          @for (resenia of resenias; track $index) {
          <div class="review-item">
            <div class="reviewer-info">
              <span class="reviewer-name">{{
                resenia.nombreCliente || 'Cliente #' + resenia.idCliente
              }}</span>
              <div class="review-rating">
                @for (estrella of estrellas; track estrella) {
                <span class="star" [class.filled]="estrella <= resenia.puntuacion">‚òÖ</span>
                }
                <span class="rating-value">({{ formatearPuntuacion(resenia.puntuacion) }})</span>
              </div>
            </div>
            <p class="review-text">{{ resenia.resenia }}</p>
          </div>
          }
        </div>
        } @else {
        <div class="empty-reviews">
          <p>Este restaurante a√∫n no tiene rese√±as.</p>
          <p>¬°S√© el primero en compartir tu experiencia!</p>
        </div>
        }
      </div>
    </section>
    } @else {
    <div class="error-container">
      <h2>Restaurante no encontrado</h2>
      <p>No pudimos cargar la informaci√≥n del restaurante solicitado.</p>
    </div>
    }
  </div>


  <!-- Carrito Lateral Siempre Visible -->
  <div class="cart-sidebar">
    <div class="cart-header">
      <h3>Tu Pedido</h3>
    </div>

    <div class="cart-content">
      @if (carrito.length > 0) {
      <div class="cart-items">
        @for (item of carrito; track item.producto.id) {
        <div class="cart-item">
          <div class="item-info">
            <h4>{{ item.producto.nombre }}</h4>
            <p class="item-price">{{ formatearPrecio(item.producto.precio) }}</p>
          </div>
          <div class="quantity-controls">
            <button class="quantity-btn" (click)="disminuirCantidad(item.producto.id)">-</button>
            <span class="quantity">{{ item.cantidad }}</span>
            <button class="quantity-btn" (click)="aumentarCantidad(item.producto.id)">+</button>
          </div>
          <div class="item-total">
            {{ formatearPrecio(item.producto.precio * item.cantidad) }}
          </div>
        </div>
        }
      </div>

      <div class="cart-summary">
        <div class="total-items">Total items: {{ calcularCantidadTotalItems() }}</div>
        <div class="total-price">Total: {{ formatearPrecio(calcularTotalCarrito()) }}</div>
      </div>

      <div class="cart-actions">
        <button class="clear-cart-btn" (click)="limpiarCarrito()">Limpiar Carrito</button>
        <button class="checkout-btn" (click)="procesarPedido()">Realizar Pedido</button>
      </div>
      } @else {
      <div class="empty-cart">
        <p>Tu carrito est√° vac√≠o</p>
      </div>
      }
    </div>
  </div>

  <!-- Modal de Confirmaci√≥n de Pedido -->
  @if (mostrarModalPedido) {
  <div class="modal-overlay" (click)="cerrarModalPedido()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirmar Pedido</h2>
        <button class="close-modal-btn" (click)="cerrarModalPedido()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Resumen del Pedido -->
        <div class="order-summary">
          <h3>Resumen del Pedido</h3>
          <div class="summary-items">
            @for (item of carrito; track item.producto.id) {
            <div class="summary-item">
              <span class="item-name">{{ item.cantidad }}x {{ item.producto.nombre }}</span>
              <span class="item-total">{{
                formatearPrecio(item.producto.precio * item.cantidad)
              }}</span>
            </div>
            }
          </div>
          <div class="summary-total">
            <strong>Total: {{ formatearPrecio(calcularTotalCarrito()) }}</strong>
          </div>
        </div>

        <!-- Selecci√≥n de Direcci√≥n del Cliente -->
        <div class="form-section">
          <label for="direccion">Tu Direcci√≥n de Entrega:</label>
          <select id="direccion" [(ngModel)]="direccionSeleccionada" class="form-select">
            <option value="">Selecciona tu direcci√≥n</option>
            @for (direccion of direcciones; track direccion.id) {
            <option [value]="direccion.id">
              {{ direccion.direccion }}, {{ direccion.ciudad }}
            </option>
            }
          </select>
        </div>

        <!-- Selecci√≥n de Sucursal del Restaurante -->
        <div class="form-section">
          <label for="direccionRestaurante">Sucursal del Restaurante:</label>
          <select
            id="direccionRestaurante"
            [(ngModel)]="direccionRestauranteSeleccionada"
            class="form-select"
          >
            <option value="">Selecciona una sucursal</option>
            @for (direccion of restaurante?.direcciones || []; track direccion.id) {
            <option [value]="direccion.id">
              {{ direccion.direccion }}, {{ direccion.ciudad }}, {{ direccion.pais }}
            </option>
            }
          </select>
        </div>

        <!-- Selecci√≥n de M√©todo de Pago -->
        <div class="form-section">
          <label for="metodoPago">M√©todo de Pago:</label>
          <select id="metodoPago" [(ngModel)]="metodoPagoSeleccionado" class="form-select">
            <option value="">Selecciona un m√©todo de pago</option>
            @for (tarjeta of metodosPago; track tarjeta.id) {
            <option [value]="tarjeta.id">
              {{ tarjeta.tipo }} **** {{ tarjeta.numero.slice(-4) }} - {{ tarjeta.titular }}
            </option>
            }
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button class="cancel-btn" (click)="cerrarModalPedido()" [disabled]="enviandoPedido">
          Cancelar
        </button>
        <button class="confirm-btn" (click)="confirmarPedido()" [disabled]="enviandoPedido">
          @if (enviandoPedido) { Procesando... } @else { Confirmar Pedido }
        </button>
      </div>
    </div>
  </div>
  }
</main>

<app-footer-cliente></app-footer-cliente>
