<app-header></app-header>

<main class="ver-restaurante">
  @if (loading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Cargando información del restaurante...</p>
    </div>
  } @else if (restaurante) {
    <!-- Header del Restaurante -->
    <section class="restaurant-header">
      <div class="container">
        <div class="restaurant-info">
          <h1>{{ restaurante.nombre }}</h1>
          @if (resenias.length > 0) {
            <div class="rating-info">
              <span class="stars">
                @for (estrella of estrellas; track estrella) {
                  <span [class.filled]="estrella <= calcularPromedioPuntuacion()">★</span>
                }
              </span>
              <span class="rating-text">
                {{ formatearPuntuacion(calcularPromedioPuntuacion()) }} 
                ({{ resenias.length }} {{ resenias.length === 1 ? 'reseña' : 'reseñas' }})
              </span>
            </div>
          }
        </div>
      </div>
    </section>

    <!-- Menú del Restaurante -->
    <section class="menu-section">
      <div class="container">
        <div class="section-header">
          <h2>Menú</h2>
          <p>Descubre nuestra deliciosa selección de platos</p>
        </div>

        @if (loadingMenu) {
          <div class="loading-menu">
            <div class="loading-spinner"></div>
            <p>Cargando menú...</p>
          </div>
        } @else if (menu.length > 0) {
          <div class="menu-grid">
            @for (producto of menu; track producto.id) {
              <div class="menu-item">
                <div class="item-content">
                  <h3>{{ producto.nombre }}</h3>
                  <p class="price">{{ formatearPrecio(producto.precio) }}</p>
                </div>
                <button class="add-btn" type="button">
                  <span>+</span>
                </button>
              </div>
            }
          </div>
        } @else {
          <div class="empty-menu">
            <p>Este restaurante aún no tiene productos en su menú.</p>
          </div>
        }
      </div>
    </section>

    <!-- Sección de Reseñas -->
    <section class="reviews-section">
      <div class="container">
        <div class="section-header">
          <h2>Reseñas</h2>
          <button 
            class="review-btn" 
            type="button"
            (click)="toggleFormularioResenia()">
            {{ mostrarFormularioResenia ? 'Cancelar' : 'Escribir Reseña' }}
          </button>
        </div>

        <!-- Formulario para Nueva Reseña -->
        @if (mostrarFormularioResenia) {
          <div class="review-form-container">
            <form [formGroup]="reseniaForm" (ngSubmit)="submitResenia()" class="review-form">
              <h3>Deja tu reseña</h3>
              
              <!-- Rating -->
              <div class="rating-input">
                <label>Calificación:</label>
                <div class="stars-input">
                  @for (estrella of estrellas; track estrella) {
                    <button 
                      type="button"
                      class="star-btn"
                      [class.selected]="estrella <= reseniaForm.value.calificacion"
                      (click)="establecerPuntuacion(estrella)">
                      ★
                    </button>
                  }
                </div>
              </div>

              <!-- Comentario -->
              <div class="form-group">
                <label for="resenia">Tu comentario:</label>
                <textarea 
                  id="resenia"
                  formControlName="resenia"
                  placeholder="Cuéntanos sobre tu experiencia..."
                  rows="4">
                </textarea>
                @if (reseniaForm.get('resenia')?.touched && reseniaForm.get('resenia')?.errors) {
                  <div class="error-message">
                    @if (reseniaForm.get('resenia')?.errors?.['required']) {
                      El comentario es obligatorio
                    }
                    @if (reseniaForm.get('resenia')?.errors?.['minlength']) {
                      El comentario debe tener al menos 10 caracteres
                    }
                    @if (reseniaForm.get('resenia')?.errors?.['maxlength']) {
                      El comentario no puede exceder los 500 caracteres
                    }
                  </div>
                }
              </div>

              <!-- Botones -->
              <div class="form-actions">
                <button 
                  type="button" 
                  class="cancel-btn"
                  (click)="toggleFormularioResenia()">
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  class="submit-btn"
                  [disabled]="reseniaForm.invalid || submittingResenia">
                  @if (submittingResenia) {
                    Enviando...
                  } @else {
                    Enviar Reseña
                  }
                </button>
              </div>
            </form>
          </div>
        }

        <!-- Lista de Reseñas -->
        @if (resenias.length > 0) {
          <div class="reviews-list">
            @for (resenia of resenias; track $index) {
              <div class="review-item">
                <div class="review-header">
                  <div class="reviewer-info">
                    <span class="reviewer-name">{{ resenia.nombreCliente || 'Cliente Anónimo' }}</span>
                    <div class="review-rating">
                      @for (estrella of estrellas; track estrella) {
                        <span [class.filled]="estrella <= resenia.calificacion">★</span>
                      }
                      <span class="rating-value">({{ formatearPuntuacion(resenia.calificacion) }})</span>
                    </div>
                  </div>
                </div>
                <p class="review-text">{{ resenia.comentario }}</p>
              </div>
            }
          </div>
        } @else {
          <div class="empty-reviews">
            <p>Este restaurante aún no tiene reseñas.</p>
            <p>¡Sé el primero en compartir tu experiencia!</p>
          </div>
        }
      </div>
    </section>
  } @else {
    <div class="error-container">
      <h2>Restaurante no encontrado</h2>
      <p>No pudimos cargar la información del restaurante solicitado.</p>
    </div>
  }
</main>

<app-footer></app-footer>
