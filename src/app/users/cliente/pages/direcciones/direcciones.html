<app-header></app-header>

<div class="content">
  <div class="container">
    <h2>Gestión de Direcciones</h2>

    <!-- Mensaje de éxito o error -->
    @if (mensajeDireccion && tipoMensajeDireccion) {
    <div
      class="alert-message"
      [class.alert-success]="tipoMensajeDireccion === 'success'"
      [class.alert-error]="tipoMensajeDireccion === 'error'"
    >
      <span class="alert-icon">{{ tipoMensajeDireccion === 'success' ? '✓' : '⚠' }}</span>
      <span class="alert-text">{{ mensajeDireccion }}</span>
    </div>
    }

    <div class="direcciones-section">
      <div class="direcciones-main">
        <div class="actions-bar">
          <button class="btn-nuevo" (click)="abrirPanel()">
            <span class="icon">+</span> Agregar Dirección
          </button>
        </div>

        <h3>Direcciones ({{ direcciones().length }})</h3>

        @if (cargando()) {
        <div class="loading"><div class="spinner"></div></div>
        } @if (!cargando() && direcciones().length === 0) {
        <p class="empty">No hay direcciones registradas</p>
        } @if (!cargando() && direcciones().length > 0) {
        <div class="direcciones-list">
          @for (direccion of direcciones(); track direccion.id) {
          <div class="direccion-item" (click)="editarDireccion(direccion)">
            <div class="direccion-header">
              <span class="direccion-nombre">{{ direccion.direccion }}</span>
            </div>
            <div class="direccion-info">
              <p class="descripcion">{{ direccion.ciudad }}, {{ direccion.pais }}</p>
              <div class="direccion-meta">
                <span class="cp-badge">CP: {{ direccion.codigoPostal }}</span>
              </div>
            </div>
          </div>
          }
        </div>
        }
      </div>

      @if (panelAbierto()) {
      <div class="direccion-form-panel">
        <div class="panel-header">
          <h4>{{ editandoId() ? 'Editar Dirección' : 'Nueva Dirección' }}</h4>
          <button class="close-btn" (click)="cerrarPanel()">×</button>
        </div>

        <form
          class="panel-content"
          [formGroup]="formularioDireccion"
          (ngSubmit)="guardarDireccion()"
        >
          <div class="form-section">
            <div class="form-group">
              <label for="direccion">Dirección *</label>
              <input
                type="text"
                id="direccion"
                formControlName="direccion"
                placeholder="Ej: Av. Corrientes 1234"
              />
              @if (formularioDireccion.get('direccion')?.invalid &&
              formularioDireccion.get('direccion')?.touched) {
              <small class="error">Dirección requerida (5-100 caracteres)</small>
              }
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="ciudad">Ciudad *</label>
                <input
                  type="text"
                  id="ciudad"
                  formControlName="ciudad"
                  placeholder="Ej: Buenos Aires"
                  maxlength="50"
                />
                @if (formularioDireccion.get('ciudad')?.invalid &&
                formularioDireccion.get('ciudad')?.touched) {
                <small class="error"
                  >@if (formularioDireccion.get('ciudad')?.hasError('required')) { Ciudad requerida
                  } @else if (formularioDireccion.get('ciudad')?.hasError('pattern')) { La ciudad
                  solo puede contener letras } @else { Mínimo 2 caracteres }
                </small>
                }
              </div>

              <div class="form-group">
                <label for="pais">País *</label>
                <select id="pais" formControlName="pais" class="form-select">
                  <option value="">Selecciona un país</option>
                  <option value="Argentina">Argentina</option>
                  <option value="Bolivia">Bolivia</option>
                  <option value="Brasil">Brasil</option>
                  <option value="Chile">Chile</option>
                  <option value="Colombia">Colombia</option>
                  <option value="Costa Rica">Costa Rica</option>
                  <option value="Cuba">Cuba</option>
                  <option value="Ecuador">Ecuador</option>
                  <option value="El Salvador">El Salvador</option>
                  <option value="España">España</option>
                  <option value="Guatemala">Guatemala</option>
                  <option value="Honduras">Honduras</option>
                  <option value="México">México</option>
                  <option value="Nicaragua">Nicaragua</option>
                  <option value="Panamá">Panamá</option>
                  <option value="Paraguay">Paraguay</option>
                  <option value="Perú">Perú</option>
                  <option value="Puerto Rico">Puerto Rico</option>
                  <option value="República Dominicana">República Dominicana</option>
                  <option value="Uruguay">Uruguay</option>
                  <option value="Venezuela">Venezuela</option>
                </select>
                @if (formularioDireccion.get('pais')?.invalid &&
                formularioDireccion.get('pais')?.touched) {
                <small class="error">
                  @if (formularioDireccion.get('pais')?.hasError('required')) { País requerido }
                  @else if (formularioDireccion.get('pais')?.hasError('pattern')) { El país solo
                  puede contener letras } @else { Mínimo 2 caracteres }
                </small>
                }
              </div>
            </div>

            <div class="form-group">
              <label for="codigoPostal">Código Postal *</label>
              <input
                type="text"
                id="codigoPostal"
                formControlName="codigoPostal"
                placeholder="Ej: 1425"
                maxlength="10"
                pattern="[0-9]*"
                inputmode="numeric"
              />
              @if (formularioDireccion.get('codigoPostal')?.invalid &&
              formularioDireccion.get('codigoPostal')?.touched) {
              <small class="error">CP requerido (4-10 dígitos)</small>
              }
            </div>
          </div>

          <div class="form-actions">
            <button
              type="submit"
              class="btn-guardar"
              [disabled]="formularioDireccion.invalid || cargando()"
            >
              {{ editandoId() ? 'Guardar Cambios' : 'Agregar Dirección' }}
            </button>
            @if (editandoId()) {
            <button type="button" class="btn-eliminar" (click)="eliminarDireccion(editandoId()!)">
              Eliminar Dirección
            </button>
            }
            <button type="button" class="btn-cancelar" (click)="cerrarPanel()">Cancelar</button>
          </div>
        </form>
      </div>
      }
    </div>
  </div>
</div>

<!-- Modal de confirmación -->
@if (confirmandoEliminacion()) {
<div class="modal-overlay" (click)="cancelarEliminacion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirmar eliminación</h3>
      <button class="close-btn" (click)="cancelarEliminacion()">×</button>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro de que deseas eliminar esta dirección?</p>
      <p class="modal-warning">Esta acción no se puede deshacer.</p>
    </div>
    <div class="modal-actions">
      <button class="btn-confirmar" (click)="confirmarEliminacion()">Eliminar</button>
      <button class="btn-cancelar-modal" (click)="cancelarEliminacion()">Cancelar</button>
    </div>
  </div>
</div>
}

<!-- Modal de alerta -->
@if (mostrarModalAlerta) {
<div class="modal-overlay" (click)="cerrarModalAlerta()">
  <div class="modal-content-alerta {{ tipoAlerta }}" (click)="$event.stopPropagation()">
    <div class="modal-header-alerta">
      <h3>{{ tituloAlerta }}</h3>
      <button class="close-btn-alerta" (click)="cerrarModalAlerta()">×</button>
    </div>
    <div class="modal-body-alerta">
      <p>{{ mensajeAlerta }}</p>
    </div>
    <div class="modal-actions-alerta">
      <button class="btn-aceptar" (click)="cerrarModalAlerta()">Aceptar</button>
    </div>
  </div>
</div>
}

<app-footer-cliente></app-footer-cliente>
